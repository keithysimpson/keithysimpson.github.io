<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Meal Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        .meal-card.dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border-color: #38bdf8;
            border-style: dashed;
        }
        #ghost-drag-element {
            position: absolute;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.8;
            transform: translate(-50%, -50%);
        }
        .meal-image-preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased overflow-hidden">

    <div id="app" class="h-screen w-screen flex flex-col">

        <!-- Main Content -->
        <main class="flex-1 flex overflow-hidden">
            <!-- Days Column -->
            <div class="w-2/5 md:w-1/3 border-r border-gray-200 flex flex-col bg-white">
                <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-semibold">This Week</h2>
                    <div class="space-x-2">
                        <button id="prev-week-btn" class="p-1 rounded-full hover:bg-gray-200">&lt;</button>
                        <button id="next-week-btn" class="p-1 rounded-full hover:bg-gray-200">&gt;</button>
                    </div>
                </div>
                <div id="days-container" class="flex-1 overflow-y-auto p-2 space-y-2"></div>
            </div>

            <!-- Meals Column -->
            <div class="w-3/5 md:w-2/3 flex flex-col">
                <div class="p-3 border-b border-gray-200 bg-white flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Meals</h2>
                    <button id="add-meal-btn-inline" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg shadow transition-transform transform hover:scale-105">
                        +
                    </button>
                </div>
                <div id="meals-container" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
            </div>
        </main>
    </div>

    <!-- Add Meal Modal -->
    <div id="add-meal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add a New Meal</h3>
            <div class="space-y-4">
                <div>
                    <label for="meal-name" class="block text-sm font-medium text-gray-700">Meal Name</label>
                    <input type="text" id="meal-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="meal-emoji" class="block text-sm font-medium text-gray-700">Emoji (or upload an image below)</label>
                    <input type="text" id="meal-emoji" placeholder="e.g., ðŸ•, ðŸ”, ðŸ¥—" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="meal-image" class="block text-sm font-medium text-gray-700">Image</label>
                    <input type="file" id="meal-image" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div>
                    <label for="meal-color" class="block text-sm font-medium text-gray-700">Card Color</label>
                    <input type="color" id="meal-color" value="#FFFFFF" class="mt-1 block w-full h-10 p-1 border border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-add-meal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="save-meal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Save Meal</button>
            </div>
        </div>
    </div>

    <!-- Ghost element for touch drag -->
    <div id="ghost-drag-element" class="hidden"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Setup ---
        // Your web app's Firebase configuration
        
        const firebaseConfig = {
            apiKey: "AIzaSyB6FoEL9fomhWEMUfyaNnYKWt50TF8Lj1s",
            authDomain: "mealplanner-317b2.firebaseapp.com",
            projectId: "mealplanner-317b2",
            storageBucket: "mealplanner-317b2.firebasestorage.app",
            messagingSenderId: "892476898899",
            appId: "1:892476898899:web:64aefed73a01a728df90a6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let mealsCollectionRef;
        let plannedMealsCollectionRef;

        let mealsUnsubscribe = () => {};
        let plannedMealsUnsubscribe = () => {};

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                setupFirestoreListeners();
            } else {
                // User is signed out. Sign them in anonymously.
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                });
            }
        });

        function setupFirestoreListeners() {
            if (!userId) return;

            // This is just a name for your app's data folder in the database.
            // You can change it to whatever you like.
            const appId = 'my-meal-planner'; 

            // Public meals collection
            mealsCollectionRef = collection(db, `artifacts/${appId}/public/data/meals`);

            // Private planned meals collection for the user
            plannedMealsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/planned_meals`);
            
            // Unsubscribe from previous listeners if they exist
            mealsUnsubscribe();
            plannedMealsUnsubscribe();
            
            // Listener for meals
            mealsUnsubscribe = onSnapshot(mealsCollectionRef, (snapshot) => {
                const meals = [];
                snapshot.forEach((doc) => {
                    meals.push({ id: doc.id, ...doc.data() });
                });
                renderMeals(meals);
            });

            // Listener for planned meals
            plannedMealsUnsubscribe = onSnapshot(plannedMealsCollectionRef, (snapshot) => {
                const plannedMeals = {};
                snapshot.forEach((doc) => {
                    plannedMeals[doc.id] = doc.data();
                });
                window.state.plannedMeals = plannedMeals;
                renderDays(); // Re-render days to show the new plans
            });
        }
        
        // --- App State ---
        window.state = {
            currentDate: new Date(),
            plannedMeals: {}, // { 'YYYY-MM-DD': { mealId: '...', name: '...', emoji: '...' } }
            draggedItem: null, // { id: '...', name: '...', emoji: '...' }
        };

        // --- DOM Elements ---
        const daysContainer = document.getElementById('days-container');
        const mealsContainer = document.getElementById('meals-container');
        const prevWeekBtn = document.getElementById('prev-week-btn');
        const nextWeekBtn = document.getElementById('next-week-btn');
        const modal = document.getElementById('add-meal-modal');
        const addMealBtn = document.getElementById('add-meal-btn-inline');
        const cancelMealBtn = document.getElementById('cancel-add-meal');
        const saveMealBtn = document.getElementById('save-meal-btn');
        const mealNameInput = document.getElementById('meal-name');
        const mealEmojiInput = document.getElementById('meal-emoji');
        const mealImageInput = document.getElementById('meal-image');
        const mealColorInput = document.getElementById('meal-color');

        // --- Date Helper Functions ---
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        const getStartOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            return new Date(d.setDate(diff));
        };

        const getRandomPastelColor = () => {
            const h = Math.floor(Math.random() * 360);
            return `hsl(${h}, 70%, 85%)`;
        };

        // --- Rendering Functions ---
        function renderDays() {
            daysContainer.innerHTML = '';
            const startOfWeek = getStartOfWeek(window.state.currentDate);

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                const dateString = formatDate(dayDate);

                const dayOfWeek = dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dateDisplay = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const plannedMeal = window.state.plannedMeals[dateString];

                const dayEl = document.createElement('div');
                dayEl.className = 'p-3 border border-gray-200 rounded-lg drop-zone h-24 flex flex-col justify-between';
                dayEl.dataset.date = dateString;

                dayEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-700">${dayOfWeek}</p>
                        <p class="text-sm text-gray-500">${dateDisplay}</p>
                    </div>
                    <div class="planned-meal-container min-h-[40px]">
                        ${plannedMeal ? createPlannedMealElement(plannedMeal, dateString).outerHTML : ''}
                    </div>
                `;
                daysContainer.appendChild(dayEl);
            }
        }

        function createPlannedMealElement(meal, date) {
            const mealEl = document.createElement('div');
            mealEl.className = 'meal-card planned-meal p-2 rounded-md shadow-sm flex items-center justify-between cursor-grab';
            mealEl.style.backgroundColor = meal.color;
            mealEl.draggable = true;
            mealEl.dataset.mealId = meal.mealId;
            mealEl.dataset.mealName = meal.name;
            mealEl.dataset.mealEmoji = meal.emoji;
            mealEl.dataset.mealImageUrl = meal.imageUrl || '';
            mealEl.dataset.mealColor = meal.color;
            mealEl.dataset.originDate = date;

            const iconHtml = meal.imageUrl 
                ? `<img src="${meal.imageUrl}" alt="${meal.name}" class="meal-image-preview">` 
                : `<span class="text-lg">${meal.emoji}</span>`;

            mealEl.innerHTML = `
                ${iconHtml}
                <span class="text-sm font-medium ml-2 truncate flex-1">${meal.name}</span>
                <button class="remove-meal-btn text-red-500 hover:text-red-700 ml-2">&times;</button>
            `;
            return mealEl;
        }

        function renderMeals(meals) {
            mealsContainer.innerHTML = '';
            meals.forEach(meal => {
                const mealEl = document.createElement('div');
                mealEl.className = 'meal-card p-3 rounded-lg shadow cursor-grab transition-transform transform hover:scale-105 flex flex-col items-center justify-center';
                mealEl.style.backgroundColor = meal.color;
                mealEl.draggable = true;
                mealEl.dataset.mealId = meal.id;
                mealEl.dataset.mealName = meal.name;
                mealEl.dataset.mealEmoji = meal.emoji;
                mealEl.dataset.mealImageUrl = meal.imageUrl || '';
                mealEl.dataset.mealColor = meal.color;

                const iconHtml = meal.imageUrl 
                    ? `<img src="${meal.imageUrl}" alt="${meal.name}" class="w-12 h-12 object-cover rounded-full mb-2">`
                    : `<div class="text-4xl mb-2">${meal.emoji}</div>`;

                mealEl.innerHTML = `
                    ${iconHtml}
                    <p class="text-center font-medium text-sm truncate w-full">${meal.name}</p>
                `;
                mealsContainer.appendChild(mealEl);
            });
        }
        
        // --- Event Listeners ---
        prevWeekBtn.addEventListener('click', () => {
            window.state.currentDate.setDate(window.state.currentDate.getDate() - 7);
            renderDays();
        });

        nextWeekBtn.addEventListener('click', () => {
            window.state.currentDate.setDate(window.state.currentDate.getDate() + 7);
            renderDays();
        });

        // Modal listeners
        addMealBtn.addEventListener('click', () => modal.classList.remove('hidden') || modal.classList.add('flex'));
        cancelMealBtn.addEventListener('click', () => modal.classList.add('hidden') || modal.classList.remove('flex'));
        
        saveMealBtn.addEventListener('click', async () => {
            const name = mealNameInput.value.trim();
            let emoji = mealEmojiInput.value.trim();
            const imageFile = mealImageInput.files[0];
            let color = mealColorInput.value;

            if (!name) {
                // You might want to show an error to the user
                console.error("Meal name is required.");
                return;
            }

            let imageUrl = null;

            if (imageFile) {
                try {
                    imageUrl = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => resolve(event.target.result);
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(imageFile); // This gives a Base64 string
                    });
                } catch (error) {
                    console.error("Error reading image file:", error);
                    return; // Don't proceed if image reading fails
                }
            }

            if (!emoji && !imageUrl) {
                emoji = 'ðŸ½ï¸';
            }

            if (color === '#ffffff') {
                color = getRandomPastelColor();
            }

            if (userId) {
                 try {
                    await addDoc(mealsCollectionRef, {
                        name,
                        emoji,
                        imageUrl,
                        color,
                        createdAt: serverTimestamp()
                    });
                    mealNameInput.value = '';
                    mealEmojiInput.value = '';
                    mealImageInput.value = ''; // Clear file input
                    mealColorInput.value = '#ffffff'; // Reset color picker
                    modal.classList.add('hidden') || modal.classList.remove('flex');
                } catch (error) {
                    console.error("Error adding meal:", error);
                }
            }
        });


        // --- Drag and Drop Logic ---
        
        // For Mouse
        document.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('meal-card')) {
                e.target.classList.add('dragging');
                window.state.draggedItem = { ...e.target.dataset };
            }
        });

        document.addEventListener('dragend', (e) => {
            if (e.target.classList.contains('meal-card')) {
                e.target.classList.remove('dragging');
                window.state.draggedItem = null;
            }
        });

        daysContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.drop-zone');
            if (dropZone) {
                dropZone.classList.add('drag-over');
            }
        });
        
        daysContainer.addEventListener('dragleave', (e) => {
            const dropZone = e.target.closest('.drop-zone');
            if (dropZone) {
                dropZone.classList.remove('drag-over');
            }
        });

        daysContainer.addEventListener('drop', async (e) => {
            e.preventDefault();
            const dropZone = e.target.closest('.drop-zone');
            if (dropZone && window.state.draggedItem) {
                dropZone.classList.remove('drag-over');
                const { mealId, mealName, mealEmoji, mealImageUrl, mealColor, originDate } = window.state.draggedItem;
                const targetDate = dropZone.dataset.date;
                
                // If it was moved from another day, remove the old one
                if (originDate && originDate !== targetDate && userId) {
                     await deleteDoc(doc(plannedMealsCollectionRef, originDate));
                }

                // Add to the new day
                if(userId) {
                    await setDoc(doc(plannedMealsCollectionRef, targetDate), {
                        mealId: mealId,
                        name: mealName,
                        emoji: mealEmoji,
                        imageUrl: mealImageUrl,
                        color: mealColor,
                    });
                }
            }
        });
        
        // Remove button on planned meals
        daysContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('remove-meal-btn')) {
                const plannedMealEl = e.target.closest('.planned-meal');
                const date = plannedMealEl.dataset.originDate;
                if (date && userId) {
                    await deleteDoc(doc(plannedMealsCollectionRef, date));
                }
            }
        });

        // --- Touch-based Drag and Drop ---
        let ghostEl = document.getElementById('ghost-drag-element');
        let currentDropZone = null;

        document.addEventListener('touchstart', (e) => {
            const mealCard = e.target.closest('.meal-card');
            if (mealCard) {
                window.state.draggedItem = { ...mealCard.dataset };
                
                // Create and position the ghost element
                ghostEl.innerHTML = mealCard.innerHTML;
                ghostEl.className = mealCard.className; // Copy classes
                ghostEl.classList.remove('cursor-grab');
                ghostEl.style.width = `${mealCard.offsetWidth}px`;
                ghostEl.style.height = `${mealCard.offsetHeight}px`;
                ghostEl.style.left = `${e.touches[0].clientX}px`;
                ghostEl.style.top = `${e.touches[0].clientY}px`;
                ghostEl.classList.remove('hidden');

                mealCard.classList.add('dragging');
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (window.state.draggedItem) {
                e.preventDefault(); // Prevent scrolling
                ghostEl.style.left = `${e.touches[0].clientX}px`;
                ghostEl.style.top = `${e.touches[0].clientY}px`;
                
                // Hide ghost to find element underneath
                ghostEl.classList.add('hidden');
                let elementUnder = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
                ghostEl.classList.remove('hidden');

                let dropZone = elementUnder ? elementUnder.closest('.drop-zone') : null;
                
                if (currentDropZone && currentDropZone !== dropZone) {
                    currentDropZone.classList.remove('drag-over');
                }
                if (dropZone) {
                    dropZone.classList.add('drag-over');
                    currentDropZone = dropZone;
                } else {
                    currentDropZone = null;
                }
            }
        }, { passive: false });

        document.addEventListener('touchend', async (e) => {
            if (window.state.draggedItem) {
                ghostEl.classList.add('hidden');
                document.querySelector('.dragging')?.classList.remove('dragging');

                if (currentDropZone) {
                    currentDropZone.classList.remove('drag-over');
                    const { mealId, mealName, mealEmoji, mealImageUrl, mealColor, originDate } = window.state.draggedItem;
                    const targetDate = currentDropZone.dataset.date;
                    
                    if (originDate && originDate !== targetDate && userId) {
                        await deleteDoc(doc(plannedMealsCollectionRef, originDate));
                    }
                    if(userId){
                         await setDoc(doc(plannedMealsCollectionRef, targetDate), {
                            mealId: mealId,
                            name: mealName,
                            emoji: mealEmoji,
                            imageUrl: mealImageUrl,
                            color: mealColor,
                        });
                    }
                }
                
                window.state.draggedItem = null;
                currentDropZone = null;
            }
        });


        // --- Initial Load ---
        renderDays();

    </script>

</body>
</html>
